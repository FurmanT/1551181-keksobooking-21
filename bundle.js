(()=>{"use strict";(()=>{const e=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};window.utils={getPriceTypeHousing:function(e){switch(e){case"bungalow":return"0";case"flat":return"1 000";case"house":return"5 000";case"palace":return"10 000";default:return""}},getDescTypeHousing:function(e){switch(e){case"flat":return"Квартира";case"bungalow":return"Бунгало";case"house":return"Дом";case"palace":return"Дворец";default:return""}},getRandomBetween:e,getRandomNumber:function(e){return Math.floor(Math.random()*e)},getRandomArray:function(t){let n=e(1,t.length),o=[];for(let r=0;r<n;r++){let n=!1;do{let r=e(0,t.length-1);-1===o.indexOf(t[r])&&(o.push(t[r]),n=!0)}while(!1===n)}return o},showErrorOnBody:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),window.page={setDisabledState:function(){window.form.setInitDisable(),window.form.setInitAddressFieldAd(),window.map.setDisable()},setActiveState:function(){let e=!1;return function(){e||(window.form.setActive(),window.map.setActive(),e=!0)}}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:function(t){const n=Math.min(t.length,5),o=document.createDocumentFragment();return Array.from({length:n},(function(e,t){return t})).forEach((function(n){o.appendChild(function(t,n){const o=e.cloneNode(!0),r=o.querySelector("img");return r.alt=t.offer.title,r.src=t.author.avatar,r.setAttribute("data-id",n),o.style=`left: ${t.location.x-25}px; top: ${t.location.y-70}px;`,o}(t[n],n))})),o}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#card").content.querySelector(".map__card");window.card={create:function(e){const n=document.createDocumentFragment();return n.appendChild(function(e){const n=t.cloneNode(!0),o=n.querySelector(".popup__title");e.offer.title?o.textContent=e.offer.title:o.hidden=!0;const r=n.querySelector(".popup__text--address");e.offer.address?r.textContent=e.offer.address:r.hidden=!0;const i=n.querySelector(".popup__text--price");e.offer.price?i.textContent=e.offer.price+" ₽/ночь":i.hidden=!0;const a=n.querySelector(".popup__type");e.offer.type?a.textContent=window.utils.getDescTypeHousing(e.offer.type):a.hidden=!0;const c=n.querySelector(".popup__text--capacity");e.offer.rooms&&e.offer.guests?c.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`:c.hidden=!0;const s=n.querySelector(".popup__text--time");e.offer.checkin&&e.offer.checkout?s.textContent=`Заезд после ${e.offer.checkin}  выезд до ${e.offer.checkout}`:s.hidden=!0;const u=n.querySelector(".popup__features");if(e.offer.features){const t=u.querySelectorAll(".popup__feature"),n=e.offer.features.map((function(e){return"popup__feature--"+e}));t.forEach((e=>{-1===n.indexOf(e.classList[1])&&e.remove()}))}else u.hidden=!0;const d=n.querySelector(".popup__description");e.offer.description?d.textContent=e.offer.description:d.hidden=!0;const l=n.querySelector(".popup__photos");if(e.offer.photos){let t=l.querySelector(".popup__photo");e.offer.photos.forEach((e=>{const n=t.cloneNode();n.src=e,l.append(n)})),t.remove()}else l.hidden=!0;const f=n.querySelector(".popup__avatar");return e.author.avatar?f.src=e.author.avatar:f.hidden=!0,n}(e)),n},remove:function(){const t=e.querySelector(".map__card");t&&t.remove()}}})(),(()=>{let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e="any",t=1e4,n=document.querySelector(".map"),o=n.querySelector(".map__pins"),r=o.querySelector(".map__pin--main"),i=r.style.left,a=r.style.top;let c=[];const s=n.querySelector(".map__filters");let u=[];const d=s.querySelector("fieldset").querySelectorAll(".map__checkbox"),l=function(n){let o=c,r=[];switch(d.forEach((function(e){e.checked&&r.push(e.value)})),n.target.name){case"housing-type":n.target.value&&n.target.value!==e&&(o=o.filter((function(e){return e.offer.type===n.target.value})));break;case"housing-price":n.target.value&&n.target.value!==e&&(o=o.filter((function(e){return"middle"===n.target.value?parseInt(e.offer.price,10)>t&&parseInt(e.offer.price,10)<5e4:"low"===n.target.value?parseInt(e.offer.price,10)<t:"high"!==n.target.value||parseInt(e.offer.price,10)>t})));break;case"housing-rooms":n.target.value&&n.target.value!==e&&(o=o.filter((function(e){return e.offer.rooms===parseInt(n.target.value,10)})));break;case"housing-guests":n.target.value&&n.target.value!==e&&(o=o.filter((function(e){return e.offer.guests===parseInt(n.target.value,10)})));break;case"features":0!==r.length&&(o=o.filter((function(e){return r.every((function(t){return-1!==e.offer.features.indexOf(t)}))})))}u=o,window.debounce(y)},f=function(e){c=e,u=e,y()},p=function(e){let t=e.target.getAttribute("data-id");if("IMG"===e.target.tagName&&t){const e=o.querySelector(".map__card");e&&e.remove(),o.appendChild(window.card.create(u[t])),o.querySelector(".popup__close").addEventListener("click",w),document.addEventListener("keydown",v)}},m=function(e){if("Enter"===e.key){let t=e.target.getAttribute("data-id");if("IMG"===e.target.tagName&&t){const e=o.querySelector(".map__card");e&&e.remove(),o.appendChild(window.card.create(u[t])),o.querySelector(".popup__close").addEventListener("click",w),document.addEventListener("keydown",v)}}},y=function(){o.removeEventListener("click",p),window.card.remove(),o.querySelectorAll(".map__pin").forEach((function(e,t){0!==t&&e.remove()})),o.appendChild(window.pin.render(u)),o.addEventListener("click",p),o.addEventListener("keydown",m)},w=function(e){e.preventDefault(),g()},v=function(e){"Escape"===e.key&&(e.preventDefault(),g())},g=function(){window.card.remove(),document.removeEventListener("keydown",w),document.removeEventListener("keydown",v)},h=window.page.setActiveState();r.addEventListener("mousedown",(function(e){if(0===e.button){e.preventDefault(),h();let t={x:e.clientX,y:e.clientY};const o=function(e){e.preventDefault();const o=n.getClientRects()[0].width;let i=t.x-e.clientX,a=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const c=r.offsetLeft-i,s=r.offsetTop-a;c>-32.5&&c<o-32.5&&s>65&&s<608&&(r.style.top=r.offsetTop-a+"px",r.style.left=r.offsetLeft-i+"px",window.form.setMoveAddressFieldAd())},i=function(e){e.preventDefault(),window.form.setMoveAddressFieldAd(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}})),r.addEventListener("keydown",(function(e){"Enter"===e.key&&h()})),window.map={getSizeMainPin:function(){return{width:65,heigth:65}},setInitPointMainPin:function(){r.style.left=i,r.style.top=a},setActive:function(){n.classList.remove("map--faded");try{window.server.loadData(f,window.utils.showErrorOnBody),s.addEventListener("change",l)}catch(e){window.utils.showErrorOnBody("Ошибка при получении данных: "+e.message)}},setDisable:function(){n.classList.add("map--faded")},deletePin:function(){window.card.deleteCard(),o.querySelectorAll(".map__pin").forEach((function(e,t){0!==t&&e.remove()}))}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success");window.resultSend={showError:function(t){const n=document.createDocumentFragment();return n.appendChild(function(t){const n=e.cloneNode(!0);return n.querySelector(".error__message").textContent=t,n}(t)),n},showSuccess:function(){const e=document.createDocumentFragment();return e.appendChild(t.cloneNode(!0)),e}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.file={addPreview:function(t,n){t.addEventListener("change",(function(){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){if("IMG"===n.tagName)n.src=e.result;else{const t=n.querySelector("img");t&&t.remove();const o=document.createElement("img");o.setAttribute("alt","Фотография"),o.setAttribute("width",n.offsetWidth),o.setAttribute("height",n.offsetHeight),o.src=e.result,n.append(o)}})),e.readAsDataURL(o)}}))}}})(),(()=>{const e=window.map.getSizeMainPin().width,t=window.map.getSizeMainPin().heigth,n=document.querySelector(".ad-form"),o=n.querySelectorAll("fieldset"),r=document.querySelector(".map__filters"),i=r.querySelectorAll("select"),a=r.querySelector("fieldset"),c=n.querySelector("#address"),s=n.querySelector("#room_number"),u=n.querySelector("#capacity"),d=document.querySelector(".map").querySelector(".map__pins").querySelector(".map__pin--main"),l=document.getElementById("timein"),f=document.getElementById("timeout"),p=document.getElementById("type"),m=document.getElementById("price"),y=document.getElementsByTagName("main")[0],w=n.querySelector(".ad-form__field input[type=file]"),v=n.querySelector(".ad-form-header__preview img"),g=n.querySelector(".ad-form__upload input[type=file]"),h=n.querySelector(".ad-form__photo"),_=v.src,S=n.querySelector(".ad-form__reset"),E=function(){let n=parseInt(d.style.left,10)+e/2,o=parseInt(d.style.top,10)+t/2;c.value=Math.floor(n)+","+Math.floor(o)},q=function(){window.page.setDisabledState(),n.reset(),r.reset(),b(),window.map.setInitPointMainPin(),E(),window.map.deletePinFromMap()},b=function(){v.src=_;const e=h.querySelector("img");e&&e.remove()},L=function(e){const t=e.target.value.replace(/\s/g,""),n=e.target.getAttribute("minlength").replace(/\s/g,""),o=e.target.getAttribute("maxlength").replace(/\s/g,"");parseInt(t,10)<parseInt(n,10)||parseInt(t,10)>parseInt(o,10)?m.setCustomValidity("Укажите соответствующее количество"):m.setCustomValidity(""),m.reportValidity()},k=function(){switch(s.value){case"1":"1"===u.value?u.setCustomValidity(""):u.setCustomValidity("Укажите соответствующее количество");break;case"2":-1!==["1","2"].indexOf(u.value)?u.setCustomValidity(""):u.setCustomValidity("Укажите соответствующее количество");break;case"3":-1!==["1","2","3"].indexOf(u.value)?u.setCustomValidity(""):u.setCustomValidity("Укажите соответствующее количество");break;case"100":"0"===u.value?u.setCustomValidity(""):u.setCustomValidity("Укажите соответствующее количество")}u.reportValidity()},A=function(){const e=window.utils.getPriceTypeHousing(p.value);m.setAttribute("minlength",e),m.setAttribute("placeholder",e)},x=function(e){e.preventDefault(),y.querySelector(".error").remove(),document.removeEventListener("click",x),document.removeEventListener("keydown",x)},C=function(e){const t=window.resultSend.showError(e);y.append(t),document.addEventListener("click",x),document.addEventListener("keydown",x)},D=function(e){e.preventDefault(),y.querySelector(".success").remove(),document.removeEventListener("click",D),document.removeEventListener("keydown",D)},I=function(){y.append(window.resultSend.showSuccess()),document.addEventListener("click",D),document.addEventListener("keydown",D),q()};n.addEventListener("submit",(function(e){e.preventDefault();try{window.server.uploadData(new FormData(n),I,C)}catch(e){C("Ошибка: "+e.message)}})),window.form={setInitDisable:function(){o.forEach((function(e){e.disabled=!0})),i.forEach((function(e){e.disabled=!0})),a.disabled=!0,n.classList.add("ad-form--disabled")},setActive:function(){n.classList.remove("ad-form--disabled"),o.forEach((function(e){e.disabled=!1})),i.forEach((function(e){e.disabled=!1})),a.disabled=!1,l.addEventListener("change",(function(){f.value=l.value})),f.addEventListener("change",(function(){l.value=f.value})),p.addEventListener("change",(function(){A()})),m.addEventListener("change",L),u.addEventListener("change",(function(){k()})),s.addEventListener("change",(function(){k()})),u.value=s.value,window.file.addPreview(w,v),window.file.addPreview(g,h),S.addEventListener("click",(function(){q()})),A()},setInitAddressFieldAd:E,setMoveAddressFieldAd:function(){let n=parseInt(d.style.left,10)+e/2,o=parseInt(d.style.top,10)+t;c.value=Math.floor(n)+","+Math.floor(o)}}})(),window.page.setDisabledState(),(()=>{const e="json";window.server={loadData:function(t,n){const o=new XMLHttpRequest;o.responseType=e,o.addEventListener("load",(function(){let e;switch(o.status){case 200:t(o.response);break;case 400:e="Неверный запрос";break;case 404:e="Страница не найдена";break;default:e="Cтатус ответа: : "+o.status+" "+o.statusText}e&&n(e)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},uploadData:function(t,n,o){const r=new XMLHttpRequest;r.responseType=e,r.addEventListener("load",(function(){let e;switch(r.status){case 200:n();break;case 400:e="Неверный запрос";break;case 404:e="Страница не найдена";break;default:e="Cтатус ответа: : "+r.status+" "+r.statusText}e&&o(e)})),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t)}}})()})();