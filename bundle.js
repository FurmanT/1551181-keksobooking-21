(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(Math.random()*(t-e+1)+e);window.utils={getPriceTypeHousing:e=>{switch(e){case"bungalow":return"0";case"flat":return"1 000";case"house":return"5 000";case"palace":return"10 000";default:return""}},getDescTypeHousing:e=>{switch(e){case"flat":return"Квартира";case"bungalow":return"Бунгало";case"house":return"Дом";case"palace":return"Дворец";default:return""}},getRandomBetween:e,getRandomNumber:e=>Math.floor(Math.random()*e),getRandomArray:t=>{let r=e(1,t.length),o=[];for(let n=0;n<r;n++){let r=!1;do{let n=e(0,t.length-1);-1===o.indexOf(t[n])&&(o.push(t[n]),r=!0)}while(!1===r)}return o},showErrorOnBody:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),window.page={setDisabledState:()=>{window.form.setInitDisable(),window.form.setInitAddressFieldAd(),window.map.setDisable()},setActiveState:()=>{let e=!1;return function(){e||(window.form.setActive(),window.map.setActive(),e=!0)}}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={render:t=>{const r=Math.min(t.length,5),o=document.createDocumentFragment();return Array.from({length:r},((e,t)=>t)).forEach((r=>{o.appendChild(((t,r)=>{const o=e.cloneNode(!0);o.setAttribute("data-id",r);const n=o.querySelector("img");return n.alt=t.offer.title,n.src=t.author.avatar,o.style=`left: ${t.location.x-25}px; top: ${t.location.y-70}px;`,o})(t[r],r))})),o}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#card").content.querySelector(".map__card");window.card={create:e=>{const r=document.createDocumentFragment();return r.appendChild((e=>{const r=t.cloneNode(!0),o=r.querySelector(".popup__title");e.offer.title?o.textContent=e.offer.title:o.hidden=!0;const n=r.querySelector(".popup__text--address");e.offer.address?n.textContent=e.offer.address:n.hidden=!0;const a=r.querySelector(".popup__text--price");e.offer.price?a.textContent=e.offer.price+" ₽/ночь":a.hidden=!0;const s=r.querySelector(".popup__type");e.offer.type?s.textContent=window.utils.getDescTypeHousing(e.offer.type):s.hidden=!0;const i=r.querySelector(".popup__text--capacity");e.offer.rooms&&e.offer.guests?i.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`:i.hidden=!0;const d=r.querySelector(".popup__text--time");e.offer.checkin&&e.offer.checkout?d.textContent=`Заезд после ${e.offer.checkin}  выезд до ${e.offer.checkout}`:d.hidden=!0;const c=r.querySelector(".popup__features");if(e.offer.features){const t=c.querySelectorAll(".popup__feature"),r=e.offer.features.map((function(e){return"popup__feature--"+e}));t.forEach((e=>{-1===r.indexOf(e.classList[1])&&e.remove()}))}else c.hidden=!0;const l=r.querySelector(".popup__description");e.offer.description?l.textContent=e.offer.description:l.hidden=!0;const u=r.querySelector(".popup__photos");if(e.offer.photos){let t=u.querySelector(".popup__photo");e.offer.photos.forEach((e=>{const r=t.cloneNode();r.src=e,u.append(r)})),t.remove()}else u.hidden=!0;const p=r.querySelector(".popup__avatar");return e.author.avatar?p.src=e.author.avatar:p.hidden=!0,r})(e)),r},remove:()=>{const t=e.querySelector(".map__card");t&&t.remove()}}})(),(()=>{let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e="any",t=document.querySelector(".map"),r=t.querySelector(".map__pins"),o=r.querySelector(".map__pin--main"),n=o.style.left,a=o.style.top;let s=[];const i=t.querySelector(".map__filters");let d=[];const c=i.querySelector("fieldset");let l={};const u=(t,r,o)=>{const n=c.querySelectorAll("input[name='features']:checked");switch(r){case"housing-type":if(o&&o!==e)return t.offer.type===o;break;case"housing-price":if(o&&o!==e)return"middle"===o?parseInt(t.offer.price,10)>1e4&&parseInt(t.offer.price,10)<5e4:"low"===o?parseInt(t.offer.price,10)<1e4:"high"!==o||parseInt(t.offer.price,10)>5e4;break;case"housing-rooms":if(o&&o!==e)return t.offer.rooms===parseInt(o,10);break;case"housing-guests":if(o&&o!==e)return t.offer.guests===parseInt(o,10);break;case"features":if(n&&0!==n.length)return Array.from(n).every((e=>-1!==t.offer.features.indexOf(e.value)))}return!0},p=e=>{l[e.target.name]=e.target.value,d=[];for(let e=0;e<s.length&&d.length<5;e++)!0===Object.entries(l).every((([t,r])=>u(s[e],t,r)))&&d.push(s[e]);window.debounce(y)},m=e=>{s=e,d=e,y()},f=e=>{let t;if(g(),"BUTTON"===e.target.tagName&&(t=e.target.getAttribute("data-id"),e.target.classList.add("map__pin--active")),"IMG"===e.target.tagName&&"BUTTON"===e.target.parentElement.tagName&&(t=e.target.parentElement.getAttribute("data-id"),e.target.parentElement.classList.add("map__pin--active")),t){const e=r.querySelector(".map__card");e&&e.remove(),r.appendChild(window.card.create(d[t])),r.querySelector(".popup__close").addEventListener("click",w),document.addEventListener("keydown",v)}},y=()=>{r.removeEventListener("click",f),window.card.remove(),r.querySelectorAll(".map__pin").forEach(((e,t)=>{0!==t&&e.remove()})),r.appendChild(window.pin.render(d)),r.addEventListener("click",f)},w=e=>{e.preventDefault(),h()},v=e=>{"Escape"===e.key&&(e.preventDefault(),h())},h=()=>{g(),window.card.remove(),document.removeEventListener("keydown",w),document.removeEventListener("keydown",v)},g=()=>{const e=r.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")},_=window.page.setActiveState();o.addEventListener("mousedown",(e=>{if(0===e.button){e.preventDefault(),_();let r={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=t.getClientRects()[0].width;let a=r.x-e.clientX,s=r.y-e.clientY;r={x:e.clientX,y:e.clientY};const i=o.offsetLeft-a,d=o.offsetTop-s;i>-32.5&&i<n-32.5&&d>65&&d<565&&(o.style.top=o.offsetTop-s+"px",o.style.left=o.offsetLeft-a+"px",window.form.setMoveAddressFieldAd())},a=e=>{e.preventDefault(),window.form.setMoveAddressFieldAd(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}})),o.addEventListener("keydown",(e=>{"Enter"===e.key&&_()})),window.map={getSizeMainPin:()=>({width:65,heigth:65}),setInitPointMainPin:()=>{o.style.left=n,o.style.top=a},setActive:()=>{t.classList.remove("map--faded");try{window.server.loadData(m,window.utils.showErrorOnBody),i.addEventListener("change",p)}catch(e){window.utils.showErrorOnBody("Ошибка при получении данных: "+e.message)}},setDisable:()=>{t.classList.add("map--faded")},deletePin:()=>{window.card.remove(),r.querySelectorAll(".map__pin").forEach(((e,t)=>{0!==t&&e.remove()}))}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success");window.resultSend={showError:t=>{const r=document.createDocumentFragment();return r.appendChild((t=>{const r=e.cloneNode(!0);return r.querySelector(".error__message").textContent=t,r})(t)),r},showSuccess:()=>{const e=document.createDocumentFragment();return e.appendChild(t.cloneNode(!0)),e}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.file={addPreview:(t,r)=>{t.addEventListener("change",(()=>{const o=t.files[0],n=o.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{if("IMG"===r.tagName)r.src=e.result;else{const t=r.querySelector("img");t&&t.remove();const o=document.createElement("img");o.setAttribute("alt","Фотография"),o.setAttribute("width",r.offsetWidth),o.setAttribute("height",r.offsetHeight),o.setAttribute("src",e.result),r.append(o)}})),e.readAsDataURL(o)}}))}}})(),(()=>{const e=window.map.getSizeMainPin().width,t=window.map.getSizeMainPin().heigth,r=document.querySelector(".ad-form"),o=r.querySelectorAll("fieldset"),n=document.querySelector(".map__filters"),a=n.querySelectorAll("select"),s=n.querySelector("fieldset"),i=r.querySelector("#address"),d=r.querySelector("#room_number"),c=r.querySelector("#capacity"),l=document.querySelector(".map").querySelector(".map__pins").querySelector(".map__pin--main"),u=document.getElementById("timein"),p=document.getElementById("timeout"),m=document.getElementById("type"),f=document.getElementById("price"),y=document.getElementsByTagName("main")[0],w=r.querySelector(".ad-form__field input[type=file]"),v=r.querySelector(".ad-form-header__preview img"),h=r.querySelector(".ad-form__upload input[type=file]"),g=r.querySelector(".ad-form__photo"),_=v.src,S=r.querySelector(".ad-form__reset"),E=()=>{let r=parseInt(l.style.left,10)+e/2,o=parseInt(l.style.top,10)+t/2;i.value=Math.floor(r)+","+Math.floor(o)},q=()=>{window.page.setDisabledState(),r.reset(),n.reset(),b(),window.map.setInitPointMainPin(),E(),window.map.deletePin()},b=()=>{v.src=_;const e=g.querySelector("img");e&&e.remove()},L=e=>{const t=e.target.value.replace(/\s/g,""),r=e.target.getAttribute("minlength").replace(/\s/g,""),o=e.target.getAttribute("maxlength").replace(/\s/g,"");parseInt(t,10)<parseInt(r,10)||parseInt(t,10)>parseInt(o,10)?f.setCustomValidity("Укажите соответствующее количество"):f.setCustomValidity(""),f.reportValidity()},k=()=>{switch(d.value){case"1":"1"===c.value?c.setCustomValidity(""):c.setCustomValidity("Укажите соответствующее количество");break;case"2":-1!==["1","2"].indexOf(c.value)?c.setCustomValidity(""):c.setCustomValidity("Укажите соответствующее количество");break;case"3":-1!==["1","2","3"].indexOf(c.value)?c.setCustomValidity(""):c.setCustomValidity("Укажите соответствующее количество");break;case"100":"0"===c.value?c.setCustomValidity(""):c.setCustomValidity("Укажите соответствующее количество")}c.reportValidity()},A=()=>{const e=window.utils.getPriceTypeHousing(m.value);f.setAttribute("minlength",e),f.setAttribute("placeholder",e)},x=e=>{e.preventDefault(),y.querySelector(".error").remove(),document.removeEventListener("click",x),document.removeEventListener("keydown",x)},C=e=>{const t=window.resultSend.showError(e);y.append(t),document.addEventListener("click",x),document.addEventListener("keydown",x)},D=e=>{e.preventDefault(),y.querySelector(".success").remove(),document.removeEventListener("click",D),document.removeEventListener("keydown",D)},I=()=>{y.append(window.resultSend.showSuccess()),document.addEventListener("click",D),document.addEventListener("keydown",D),q()};r.addEventListener("submit",(e=>{e.preventDefault();try{window.server.uploadData(new FormData(r),I,C)}catch(e){C("Ошибка: "+e.message)}})),window.form={setInitDisable:()=>{o.forEach((e=>{e.disabled=!0})),a.forEach((e=>{e.disabled=!0})),s.disabled=!0,r.classList.add("ad-form--disabled")},setActive:()=>{r.classList.remove("ad-form--disabled"),o.forEach((e=>{e.disabled=!1})),a.forEach((e=>{e.disabled=!1})),s.disabled=!1,u.addEventListener("change",(()=>{p.value=u.value})),p.addEventListener("change",(()=>{u.value=p.value})),m.addEventListener("change",(()=>{A()})),f.addEventListener("change",L),c.addEventListener("change",(()=>{k()})),d.addEventListener("change",(()=>{k()})),c.value=d.value,window.file.addPreview(w,v),window.file.addPreview(h,g),S.addEventListener("click",(()=>{q()})),A()},setInitAddressFieldAd:E,setMoveAddressFieldAd:()=>{let r=parseInt(l.style.left,10)+e/2,o=parseInt(l.style.top,10)+t;i.value=Math.floor(r)+","+Math.floor(o)}}})(),window.page.setDisabledState(),(()=>{const e=(e,t)=>{let r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(function(){let o;switch(r.status){case 200:e(r.response);break;case 400:o="Неверный запрос";break;case 404:o="Страница не найдена";break;default:o="Cтатус ответа: : "+r.status+" "+r.statusText}o&&t(o)})),r.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),r};window.server={loadData:(t,r)=>{const o=e(t,r);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},uploadData:(t,r,o)=>{const n=e(r,o);n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})()})();