(()=>{"use strict";(()=>{const e=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)};window.utils={getPriceTypeHousing:function(e){switch(e){case"bungalow":return"0";case"flat":return"1 000";case"house":return"5 000";case"palace":return"10 000";default:return""}},getDescTypeHousing:function(e){switch(e){case"flat":return"Квартира";case"bungalow":return"Бунгало";case"house":return"Дом";case"palace":return"Дворец";default:return""}},getRandomBetween:e,getRandomNumber:function(e){return Math.floor(Math.random()*e)},getRandomArray:function(t){let n=e(1,t.length),o=[];for(let r=0;r<n;r++){let n=!1;do{let r=e(0,t.length-1);-1===o.indexOf(t[r])&&(o.push(t[r]),n=!0)}while(!1===n)}return o},showErrorOnBody:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),window.page={setDisabledState:function(){window.form.setDisable(),window.form.setInitAddressFieldAd()},setActiveState:function(){let e=!1;return function(){e||(window.form.setActive(),window.map.setActive(),e=!0)}}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=function(t,n){const o=e.cloneNode(!0),r=o.querySelector("img");return r.alt=t.offer.title,r.src=t.author.avatar,r.setAttribute("data-id",n),o.style=`left: ${t.location.x-25}px; top: ${t.location.y-70}px;`,o};window.pin={render:function(e){const n=Math.min(e.length,5),o=document.createDocumentFragment();for(let r=0;r<n;r++)o.appendChild(t(e[r],r));return o}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#card").content.querySelector(".map__card");window.card={create:function(e){const n=document.createDocumentFragment();return n.appendChild(function(e){const n=t.cloneNode(!0),o=n.querySelector(".popup__title");e.offer.title?o.textContent=e.offer.title:o.hidden=!0;const r=n.querySelector(".popup__text--address");e.offer.address?r.textContent=e.offer.address:r.hidden=!0;const c=n.querySelector(".popup__text--price");e.offer.price?c.textContent=e.offer.price+" ₽/ночь":c.hidden=!0;const a=n.querySelector(".popup__type");e.offer.type?a.textContent=window.utils.getDescTypeHousing(e.offer.type):a.hidden=!0;const i=n.querySelector(".popup__text--capacity");e.offer.rooms&&e.offer.guests?i.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`:i.hidden=!0;const s=n.querySelector(".popup__text--time");e.offer.checkin&&e.offer.checkout?s.textContent=`Заезд после ${e.offer.checkin}  выезд до ${e.offer.checkout}`:s.hidden=!0;const u=n.querySelector(".popup__features");e.offer.features?u.querySelectorAll(".popup__feature").forEach((t=>{e.offer.features.forEach((e=>{t.classList.contains("popup__feature--"+e)||t.remove()}))})):u.hidden=!0;const d=n.querySelector(".popup__description");e.offer.description?d.textContent=e.offer.description:d.hidden=!0;const l=n.querySelector(".popup__photos");if(e.offer.photos){let t=l.querySelector(".popup__photo");e.offer.photos.forEach((e=>{const n=t.cloneNode();n.src=e,l.append(n)})),t.remove()}else l.hidden=!0;const f=n.querySelector(".popup__avatar");return e.author.avatar?f.src=e.author.avatar:f.hidden=!0,n}(e)),n},deleteCard:function(){const t=e.querySelector(".map__card");t&&t.remove()}}})(),(()=>{let e;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=t.querySelector(".map__pin--main");let o=[];const r=e.querySelector(".map__filters");let c=[];const a=r.querySelector("fieldset").querySelectorAll(".map__checkbox"),i=function(e){let t=o,n=[];switch(a.forEach((function(e){e.checked&&n.push(e.value)})),e.target.name){case"housing-type":e.target.value&&"any"!==e.target.value&&(t=t.filter((function(t){return t.offer.type===e.target.value})));break;case"housing-price":e.target.value&&"any"!==e.target.value&&(t=t.filter((function(t){return"middle"===e.target.value?parseInt(t.offer.price,10)>1e4&&parseInt(t.offer.price,10)<5e4:"low"===e.target.value?parseInt(t.offer.price,10)<1e4:"high"!==e.target.value||parseInt(t.offer.price,10)>1e4})));break;case"housing-rooms":e.target.value&&"any"!==e.target.value&&(t=t.filter((function(t){return t.offer.rooms===parseInt(e.target.value,10)})));break;case"housing-guests":e.target.value&&"any"!==e.target.value&&(t=t.filter((function(t){return t.offer.guests===parseInt(e.target.value,10)})));break;case"features":0!==n.length&&(t=t.filter((function(e){return n.every((function(t){return-1!==e.offer.features.indexOf(t)}))})))}c=t,window.debounce(d)},s=function(e){o=e,c=e,d()},u=function(e){let n=e.target.getAttribute("data-id");"IMG"===e.target.tagName&&n&&(t.querySelector(".map__card")||(t.appendChild(window.card.create(c[n])),t.querySelector(".popup__close").addEventListener("click",l)))},d=function(){t.removeEventListener("click",u),window.card.deleteCard(),t.querySelectorAll(".map__pin").forEach((function(e,t){0!==t&&e.remove()})),t.appendChild(window.pin.render(c)),t.addEventListener("click",u)},l=function(e){e.preventDefault(),window.card.deleteCard()},f=window.page.setActiveState();n.addEventListener("mousedown",(function(t){if(0===t.button){t.preventDefault(),f();let o={x:t.clientX,y:t.clientY};const r=function(t){t.preventDefault();const r=e.getClientRects()[0].width;let c=o.x-t.clientX,a=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const i=n.offsetLeft-c,s=n.offsetTop-a;i>0&&i<r-65&&s>65&&s<630&&(n.style.top=n.offsetTop-a+"px",n.style.left=n.offsetLeft-c+"px",window.form.setMoveAddressFieldAd())},c=function(e){e.preventDefault(),window.form.setMoveAddressFieldAd(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",c)}})),n.addEventListener("keydown",(function(e){"Enter"===e.key&&f()})),window.map={getSizeMainPin:function(){return{width:65,heigth:65}},setActive:function(){e.classList.remove("map--faded");try{window.server.loadData(s,window.utils.showErrorOnBody),r.addEventListener("change",i)}catch(e){window.utils.showErrorOnBody("Ошибка при получении данных: "+e.message)}}}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success");window.resultSend={showError:function(t){const n=document.createDocumentFragment();return n.appendChild(function(t){const n=e.cloneNode(!0);return n.querySelector(".error__message").textContent=t,n}(t)),n},showSuccess:function(){const e=document.createDocumentFragment();return e.appendChild(t.cloneNode(!0)),e}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.file={addPreview:function(t,n){t.addEventListener("change",(function(){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){if("IMG"===n.tagName)n.src=e.result;else{const t=document.createElement("img");t.setAttribute("alt","Фотография"),t.setAttribute("width",n.offsetWidth),t.setAttribute("height",n.offsetHeight),t.src=e.result,n.append(t)}})),e.readAsDataURL(o)}}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),n=document.querySelector(".map__filters"),o=n.querySelectorAll("select"),r=n.querySelectorAll("fieldset"),c=e.querySelector("#address"),a=e.querySelector("#room_number"),i=e.querySelector("#capacity"),s=document.querySelector(".map").querySelector(".map__pins").querySelector(".map__pin--main"),u=document.getElementById("timein"),d=document.getElementById("timeout"),l=document.getElementById("type"),f=document.getElementById("price"),p=window.map.getSizeMainPin().width,m=window.map.getSizeMainPin().heigth,w=document.getElementsByTagName("main")[0],y=e.querySelector(".ad-form__field input[type=file]"),h=e.querySelector(".ad-form-header__preview img"),v=e.querySelector(".ad-form__upload input[type=file]"),g=e.querySelector(".ad-form__photo"),S=h.src,_=function(e){e.preventDefault(),w.querySelector(".error").remove(),document.removeEventListener("click",_),document.removeEventListener("keydown",_)},q=function(e){const t=window.resultSend.showError(e);w.append(t),document.addEventListener("click",_),document.addEventListener("keydown",_)},E=function(e){e.preventDefault(),w.querySelector(".success").remove(),document.removeEventListener("click",E),document.removeEventListener("keydown",E)},b=function(){w.append(window.resultSend.showSuccess()),document.addEventListener("click",E),document.addEventListener("keydown",E),window.page.setDisabledState(),e.reset(),n.reset(),h.src=S,g.querySelector("img").remove()};e.addEventListener("submit",(function(t){t.preventDefault();try{window.server.uploadData(new FormData(e),b,q)}catch(e){q("Ошибка: "+e.message)}})),window.form={setDisable:function(){t.forEach((function(e){e.disabled=!0})),o.forEach((function(e){e.disabled=!0})),r.disabled=!0},setActive:function(){e.classList.remove("ad-form--disabled"),t.forEach((function(e){e.disabled=!1})),o.forEach((function(e){e.disabled=!1})),r.disabled=!1,u.addEventListener("change",(function(){d.value=u.value})),d.addEventListener("change",(function(){u.value=d.value})),l.addEventListener("change",(function(){let e=window.utils.getPriceTypeHousing(l.value);f.setAttribute("minlength",e),f.setAttribute("placeholder",e)})),a.addEventListener("change",(function(){i.value!==a.value?a.setCustomValidity("Укажите соответствующее количество"):a.setCustomValidity(""),a.reportValidity()})),window.file.addPreview(y,h),window.file.addPreview(v,g)},setInitAddressFieldAd:function(){let e=parseInt(s.style.left,10)+p/2,t=parseInt(s.style.top,10)+m/2;c.value=Math.floor(e)+","+Math.floor(t)},setMoveAddressFieldAd:function(){let e=parseInt(s.style.left,10)+p/2,t=parseInt(s.style.top,10)+m;c.value=Math.floor(e)+","+Math.floor(t)}}})(),window.page.setDisabledState(),window.server={loadData:function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){let o;switch(n.status){case 200:e(n.response);break;case 400:o="Неверный запрос";break;case 404:o="Страница не найдена";break;default:o="Cтатус ответа: : "+n.status+" "+n.statusText}o&&t(o)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},uploadData:function(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){let e;switch(o.status){case 200:t();break;case 400:e="Неверный запрос";break;case 404:e="Страница не найдена";break;default:e="Cтатус ответа: : "+o.status+" "+o.statusText}e&&n(e)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}}})();